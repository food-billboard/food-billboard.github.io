---
title: ç»„ä»¶åº“æ‰“åŒ…é…ç½®å‚è€ƒ  
date: 2023-09-01 10:55:00
tags: frontend 
banner_img: /images/ç»„ä»¶åº“æ‰“åŒ…é…ç½®å‚è€ƒ/background.png
index_img: /images/ç»„ä»¶åº“æ‰“åŒ…é…ç½®å‚è€ƒ/background.png
categories: 
  - å‰ç«¯  
  - é…ç½®
---

# ç»„ä»¶åº“æ‰“åŒ…é…ç½®å‚è€ƒ 

## å¼€å§‹  

### babelç›¸å…³åŒ…åŠŸèƒ½  

#### @babel/preset-env

#### @babel/preset-typescript

#### @babel/preset-react  

### umdæ‰“åŒ…ç»„ä»¶åº“ 

```js 
const webpack = require('webpack')
const TerserPlugin = require('terser-webpack-plugin')
const pkg = require('../package.json')

webpack(
  {
    // å…¥å£
    entry: './es/build.js',
    // ç›®æ ‡ç¯å¢ƒ
    target: 'browserslist:>0.25%, not dead, not op_mini all',
    // æ¨¡å¼
    mode: 'production',
    output: {
      clean: true,
      filename: 'qsb-file-viewer.min.js',
      libraryTarget: 'umd',
      library: 'qsbFileViewer',
    },
    externals: {
      react: 'React',
      'react-dom': 'ReactDOM',
      moment: 'moment',
      antd: 'antd',
      axios: 'axios',
    },
    module: {
      rules: [
        {
          test: /\.m?js$/,
          loader: 'babel-loader',
          options: {
            // ç¼“å­˜ç¼–è¯‘ç»“æœ
            cacheDirectory: true,
            // åŒ…å«gzip
            cacheCompression: false,
            // æ˜¯å¦ä½¿ç”¨babelrc
            babelrc: false,
            // æ˜¯å¦ä½¿ç”¨é…ç½®æ–‡ä»¶
            configFile: false,
            // ç¼–è¯‘çš„ç±»å‹ script module unambiguous(å­˜åœ¨import/exportå°±æ˜¯moduleï¼Œå¦åˆ™æ˜¯script)
            sourceType: 'unambiguous',
            // å»é™¤æ¢è¡Œå’Œç©ºæ ¼
            compact: false,
            presets: [
              [
                '@babel/preset-env',
                {
                  // "amd" | "umd" | "systemjs" | "commonjs" | "cjs" | "auto" | false
                  // esm è½¬æ¢ä¸ºæŸä¸€ç§è§„èŒƒç±»å‹
                  modules: 'umd',
                  // æ˜¯å¦è‡ªåŠ¨å¼•å…¥polyfill
                  // false 
                  // entry(æ‰‹åŠ¨å¼•å…¥) æ ¹æ®targetä¼šè‡ªåŠ¨æ ¹æ®å¼•å…¥çš„æ¨¡å—è¿›è¡Œå…¼å®¹ï¼Œæ¯”å¦‚å¼•å…¥äº†promiseï¼Œä»–ä¼šæŠŠæ‰€æœ‰promiseçš„æ¨¡å—éƒ½å¸®åŠ©å¼•å…¥ï¼Œæ¯”å¦‚promise.any
                  // usage(æ ¹æ®ä½¿ç”¨æƒ…å†µè‡ªåŠ¨å¼•å…¥) å®Œå…¨äº¤ç»™babelå¤„ç†ï¼Œä½¿ç”¨åˆ°ä»€ä¹ˆå°±å¼•å…¥ä»€ä¹ˆï¼Œä½†æ˜¯æ¯”å¦‚å¦‚æœåªæ˜¯ä½¿ç”¨äº†promiseï¼Œåˆ™ä¸ä¼šå¼•å…¥promise.any 
                  useBuiltIns: 'entry',
                  corejs: 3,
                  // corejs: {
                  //   version: 3,
                  //   // ç¼–è¯‘ææ¡ˆçš„api 
                  //   proposals: false
                  // },
                  // Exclude transforms that make all code slower
                  exclude: ['transform-typeof-symbol'],
                },
              ],
            ],
            plugins: [
              [
                // é…åˆ@babel/runtime å°†è¾…åŠ©å‡½æ•°ç­‰ æ³¨å…¥åˆ°ä»£ç ä¸­
                '@babel/plugin-transform-runtime', 
                {
                  // å…¼å®¹æ¨¡å¼(ä¸æ±¡æŸ“å…¨å±€å±€éƒ¨å˜é‡)  
                  // è¿™é‡Œçš„corejs å’Œ å‰é¢ preset-env ç”¨ä¸€ä¸ªå°±è¡Œäº†
                  corejs: false,
                  version: require('@babel/runtime/package.json').version,
                  // true å¼•å…¥å‡½æ•° false å†…è”å‡½æ•°
                  helpers: true,
                  // async å’Œ * function çš„è¯­æ³•æ”¯æŒ 
                  // æ˜¯å¦ä¸ºå¼•å…¥ï¼ˆæˆ–è€…å†…è”ï¼‰
                  regenerator: true,
                },
              ],
            ],
          },
        },
        {
          test: /\.(png|svg|jpg|jpeg|gif)$/i,
          type: 'asset/inline',
        },
        {
          test: /\.css$/, //åŒ¹é… css æ–‡ä»¶
          use: [
            {
              loader: 'style-loader',
              options: {
                attributes: {
                  'data-module': pkg.name,
                  'data-version': pkg.version,
                },
              },
            },
            'css-loader'
          ]
        },
        {
          test: /\.less$/,
          use: [
            {
              loader: 'style-loader',
              options: {
                attributes: {
                  'data-module': pkg.name,
                  'data-version': pkg.version,
                },
              },
            },
            'css-loader',
            {
              loader: 'less-loader',
              options: {
                lessOptions: {
                  javascriptEnabled: true,
                },
              },
            },
          ],
        },
      ],
    },
    plugins: [new webpack.ProgressPlugin()],
    optimization: {
      minimizer: [
        new TerserPlugin({
          extractComments: false,
          terserOptions: {
            parse: {
              // We want terser to parse ecma 8 code. However, we don't want it
              // to apply any minification steps that turns valid ecma 5 code
              // into invalid ecma 5 code. This is why the 'compress' and 'output'
              // sections only apply transformations that are ecma 5 safe
              // https://github.com/facebook/create-react-app/pull/4234
              ecma: 8,
            },
            compress: {
              pure_funcs: ['console.log'],
              drop_debugger: true,
              ecma: 5,
              warnings: false,
              // Disabled because of an issue with Uglify breaking seemingly valid code:
              // https://github.com/facebook/create-react-app/issues/2376
              // Pending further investigation:
              // https://github.com/mishoo/UglifyJS2/issues/2011
              comparisons: false,
              // Disabled because of an issue with Terser breaking valid code:
              // https://github.com/facebook/create-react-app/issues/5250
              // Pending further investigation:
              // https://github.com/terser-js/terser/issues/120
              inline: 2,
            },
            mangle: {
              safari10: true,
            },
            // Added for profiling in devtools
            keep_classnames: false,
            keep_fnames: false,
            output: {
              ecma: 5,
              comments: false,
              // Turned on because emoji and regex is not minified properly using default
              // https://github.com/facebook/create-react-app/issues/2488
              ascii_only: true,
            },
          },
        }),
      ],
    },
    performance: {
      maxEntrypointSize: 1024 * 1024,
      maxAssetSize: 1024 * 1024,
    },
  },
  (error, stats) => {
    if (error) {
      console.error(error)
      process.exit(1)
    }

    if (stats.compilation.errors.length) {
      console.log(stats.toString({ all: false, errors: true, colors: true }))
      process.exit(1)
    }

    console.log(stats.toString({ colors: true }))
  }
)
```
  
### cjs  

#### babel 
```js
module.exports = {
  presets: [
    '@babel/preset-env', 
    '@babel/preset-typescript', 
    '@babel/preset-react'
  ],
  plugins: [
    '@babel/proposal-class-properties',
    [
      '@babel/plugin-transform-runtime',
      // ? å»æ‰ä¸‹æ–¹é…ç½®ï¼Œç”±ä¸šåŠ¡é¡¹ç›®æ§åˆ¶ç›¸å…³çš„é…ç½®  
      // {
      //   corejs: 3,
      //   helpers: true,
      // },
    ],
  ],
}
```

### ç±»å‹å¯¼å‡º

ç¬¬ä¸‰æ–¹åŒ…ç±»å‹æç¤º  
- package.json  
```json
{
  "typings": "types/index.d.ts",
  "scripts": {
    "build:types": "rimraf types && tsc --outDir types --declaration --emitDeclarationOnly",
  }
}
```

### å…¶ä»–  

#### sideEffects  
  tree-shaking å»é™¤æ— ç”¨ä»£ç   

```js
// æ‰€æœ‰æ–‡ä»¶éƒ½æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå…¨éƒ½å¯ä»¥åˆ é™¤
var sideEffects = false 

// æŒ‡å®šç›®å½•æˆ–æ–‡ä»¶æ²¡æœ‰å‰¯ä½œç”¨
var sideEffects = [
  "dist/*",
  "esm/**/style/*",
  "lib/**/style/*",
  "*.less"
]

```

## ç»“æŸ  

  ç»“æŸğŸ”šã€‚    

å‚è€ƒé“¾æ¥  
> [Babel7 ä¸­ @babel/preset-env çš„ä½¿ç”¨](https://zhuanlan.zhihu.com/p/84799735)  
> [ã€ç›®å½•ã€‘ç»„ä»¶åº“æ‰“åŒ…cliæ•™ç¨‹](https://github.com/lio-mengxiang/mx-design-cli/issues/16)   
> [react ç»„ä»¶åº“æ‰“åŒ…æŒ‡å—](https://github.com/lio-mengxiang/mx-design-cli/issues/13)   
