---
title: 数据可视化大屏设计器开发-控制刷新  
date: 2023-07-11 09:17:00
tags: lowcode react chart 
banner_img: /images/数据可视化大屏设计器开发/background.jpg
index_img: /images/数据可视化大屏设计器开发/background.jpg
categories: 
  - 前端  
  - 大屏
---

# 数据可视化大屏设计器开发-控制刷新  

## 开头  

本文是数据可视化开始的开发细节第七章。关于大屏中组件的控制刷新的逻辑。  

根据上一章内容，关于关联参数的逻辑讲解，引申的一个场景。  
一个列表组件可能依赖于多个联动组件的关联参数，比如像是[ProTable](https://procomponents.ant.design/components/table)。  

<img src="/images/数据可视化大屏设计器开发/pro-table.jpg" />  

上面的查询项的关联参数会被写入到**列表**的请求路径中，比如这样`/api/fetch/table?title={{title}}&status={{status}}`。  

但是因为关联参数的更新是响应式的，当一个查询项发生变化时，立马就会触发列表组件的`request`行为，这无疑是相当浪费资源的（除非本身就有立刻`request`的需求）。

所以需要有一种特殊的行为逻辑，只有在某些特定的条件下才会触发更新。  
比如**点击按钮**。  

## 开始  

前文介绍到，关联参数使用的三个场景（数据请求、数据过滤、条件）。  
本文也从这三个方面分别介绍下应对方案。  

> 关于下面几个方面的参数逻辑，可以参看上一篇文章，本文只介绍标题的逻辑。  

### 条件  
  相对于其他的两个场景，条件场景可能并不需要多余的处理。  
  其实本身他就是一个需要立刻响应的逻辑。  

  当用户状态发生改变，图表必然需要立刻计算是**显示**还是**隐藏**。(`へ´*)ノ  

### 数据过滤  

重新看一下数据过滤的代码  
```js
function filter(data, global) {
  const { userId } = global
  return data.filter(item => item.userId === userId) 
}
```

前面也讲到过，第二个参数是全局的关联参数，并且他是**所有**的关联参数。  

<img src="/images/数据可视化大屏设计器开发/关联参数选择.jpg" />  

之所以是将全部的关联参数注入，就是为了控制他是否触发执行。  

当在选择关联参数组件中选择了需要用到的关联参数时，在关联参数发生改变时，就会触发比较并更新。  
而如果没有选择关联参数，而是直接使用，那就不可能触发`compare`。  
我们只需要选择需要**立刻响应**的关联参数即可。  

<img src="/images/数据可视化大屏设计器开发/控制刷新-过滤器.jpg" />  

<img src="/images/数据可视化大屏设计器开发/控制刷新-过滤函数.gif" />  

如上图演示可见，虽然只是关联了参数`xx`，但是可以在过滤函数里访问另一个未被选择的关联参数`yy`。  

### 数据请求  

最后讲解的是数据请求方面的处理。（这里先不考虑`data`和`headers`的处理了）  

`url`上携带关联参数，因为只是一个字符串，很难控制其刷新，所以这里想到了采用一个简单的`Hack`手段。  
我们设置两个特殊的常量字符串用于标识。  
比如`LAZY_REQUEST_FLAG`和`IMMEDIATELY_REQUEST_FLAG`  
  - LAZY_REQUEST_FLAG  
    懒更新标识  
  - IMMEDIATELY_REQUEST_FLAG  
    立即刷新标识  

#### LAZY_REQUEST_FLAG

我们给一个需要懒更新的关联参数后面跟上`LAZY_REQUEST_FLAG`，表示它不需要立刻更新。  
`/api/fetch?userId={{userIdLAZY_REQUEST_FLAG}}`  
在收集`url`上的参数时，忽略包含`LAZY_REQUEST_FLAG`的关联参数。  
这样即使参数发生变化，`compare`也无从进行比较。  

在真正需要`request`时，先循环`replace`掉`LAZY_REQUEST_FLAG`就是原始的`url`，接着再使用[mustache](https://github.com/janl/mustache.js)来解析成最终的请求`url`。  

<img src="/images/数据可视化大屏设计器开发/关联参数-url-非懒更新.jpg" />
<img src="/images/数据可视化大屏设计器开发/关联参数-url-懒更新.jpg" />  
<img src="/images/数据可视化大屏设计器开发/关联参数-url-请求.jpg" />
<img src="/images/数据可视化大屏设计器开发/关联参数-url-请求.gif" />

> 如上图可以看到，只有当`xx`发生变化时，才会重新请求接口。  

#### IMMEDIATELY_REQUEST_FLAG  

开头讲到过关于列表存在查询项的场景。  
针对此场景，可以对查询按钮做特殊处理。  

因为按钮**点击**逻辑上，本质还是将按钮的内容作为关联参数的值传递给其他的组件的。  
但是按钮的内容并不会在每次点击都发生变化，所以可以针对**按钮**特殊处理，在点击按钮传递参数的值时，增加`IMMEDIATELY_REQUEST_FLAG`并跟上时间戳，这样就保证了组件每一次点击都是不一样的值。  

基于不同场景，增加一个按钮**类型**配置。  

<img src="/images/数据可视化大屏设计器开发/关联参数-url-按钮配置.jpg" />

> 普通按钮为点击不携带时间戳，提交按钮则会携带。  

<img src="/images/数据可视化大屏设计器开发/关联参数-url-checkbox-lazy.jpg" />

<img src="/images/数据可视化大屏设计器开发/关联参数-url-button.jpg" />

<img src="/images/数据可视化大屏设计器开发/关联参数-url-immediately-list.jpg" />

<img src="/images/数据可视化大屏设计器开发/关联参数-url-immediately.gif" />

> 如上图可以看到，通过点击按钮可以每次都触发接口请求。  

## 结束  

  以上逻辑均为本人自己的想法，如有问题或错误可指正🙏🏻 。  

  结束🔚。  

  顺便在下面附上相关的链接。  
> [试用地址](http://47.97.27.23/api/backend/screen/index.html)  
[试用账号](https://github.com/food-billboard/create-chart/issues/2)  
[静态版试用地址](https://food-billboard.github.io/create-chart/index.html#/)   
[操作文档](http://47.97.27.23/api/backend/create-chart-docs/index.html)  
[代码地址](https://github.com/food-billboard/create-chart)   

  参考链接。  
> [BI 搭建 - 筛选条件](https://github.com/ascoders/weekly/blob/master/%E5%89%8D%E6%B2%BF%E6%8A%80%E6%9C%AF/166.%E7%B2%BE%E8%AF%BB%E3%80%8ABI%20%E6%90%AD%E5%BB%BA%20-%20%E7%AD%9B%E9%80%89%E6%9D%A1%E4%BB%B6%E3%80%8B.md)